name: Build

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  plugin_test:
    name: asdf plugin test
    strategy:
      matrix:
        os:
          - ubuntu-latest
          - macos-latest
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Install asdf
        uses: asdf-vm/actions/setup@v1
        with:
          asdf_branch: v0.9.0

      - name: Install Golang (for installing odo from Git refs)
        run: |
          asdf plugin-add golang https://github.com/kennyp/asdf-golang.git
          asdf install golang 1.16.15
          asdf global golang 1.16.15

      # TODO(rm3l): remove this once asdf-odo repo becomes public
      - name: Install plugin manually
        run: |
          mkdir -p ~/.asdf/plugins
          ln -sf "$(pwd)" ~/.asdf/plugins/odo

      - name: Install and test latest odo
        run: |
          asdf install odo latest
          asdf global odo latest
          odo version

      - name: Install and test odo using Git branch from upstream repo
        env:
          GIT_REF: v2
        run: |
          asdf install odo ref:$GIT_REF
          asdf global odo ref:$GIT_REF
          version_output=$(odo version)
          grep -q "ref:$GIT_REF" <<< "$version" || \
            echo "Expected 'odo version' to contain \"ref:$GIT_REF\", but got $version_output"

      - name: Install and test odo using Git commit from upstream repo
        env:
          GIT_REF: 7618e8f3e4385bdca620e934c0b27d8fcc878099
        run: |
          asdf install odo ref:$GIT_REF
          asdf global odo ref:$GIT_REF
          version_output=$(odo version)
          grep -q "ref:$GIT_REF" <<< "$version" || \
            echo "Expected 'odo version' to contain \"ref:$GIT_REF\", but got $version_output"

      - name: Install and test odo using Git branch from fork repo
        env:
          ASDF_GITHUB_REPO_FOR_ODO: "https://github.com/rm3l/odo"
          GIT_REF: docs-getting-started-order
        run: |
          asdf install odo ref:$GIT_REF
          asdf global odo ref:$GIT_REF
          version_output=$(odo version)
          grep -q "ref:$GIT_REF" <<< "$version" || \
            echo "Expected 'odo version' to contain \"ref:$GIT_REF\", but got $version_output"

      - name: Install and test odo using Git commit from fork repo
        env:
          ASDF_GITHUB_REPO_FOR_ODO: "https://github.com/rm3l/odo"
          GIT_REF: 2c6c9f1a418c6620026a1d9908f268083a706e35
        run: |
          asdf install odo ref:$GIT_REF
          asdf global odo ref:$GIT_REF
          version_output=$(odo version)
          grep -q "ref:$GIT_REF" <<< "$version" || \
            echo "Expected 'odo version' to contain \"ref:${GIT_REF}@${ASDF_GITHUB_REPO_FOR_ODO}\", but got $version_output"
